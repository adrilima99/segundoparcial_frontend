import{b as A,c as H,f as z,h as $,i as G,j as q,k as R,m as J}from"./chunk-5TRB5RNR.js";import{a as Z}from"./chunk-IL2UONYL.js";import{c as W}from"./chunk-C5J56EWV.js";import{$a as n,Ka as s,La as V,Va as _,Ya as d,_a as k,ab as o,bb as E,cc as F,dc as L,e as Y,eb as C,fa as S,fb as g,fc as B,gb as l,gc as N,mb as r,nb as h,oa as u,ob as D,pa as p,pb as T,qa as M,ra as P,rb as x,sb as b,tb as f,vb as j,yb as O,zb as I}from"./chunk-RI4DZ32I.js";var v=Y(Z());function ee(c,m){c&1&&(n(0,"div",2),E(1,"div",3),o())}function te(c,m){if(c&1&&(n(0,"option",12),r(1),o()),c&2){let e=m.$implicit;d("ngValue",e),s(),h(e.nombre)}}function ie(c,m){c&1&&(n(0,"tr")(1,"td",27),r(2,"No hay descuentos disponibles."),o()())}function ne(c,m){if(c&1){let e=C();n(0,"tr",28)(1,"td",19),r(2),o(),n(3,"td",19),r(4),o(),n(5,"td",19),r(6),o(),n(7,"td",19),r(8),o(),n(9,"td",19),r(10),O(11,"number"),o(),n(12,"td",19)(13,"span"),r(14),o()(),n(15,"td",29)(16,"button",30),g("click",function(){let t=u(e).$implicit,a=l(2);return p(a.showEditModal(t))}),r(17," \u270F\uFE0F "),n(18,"span",31),r(19,"Editar"),o()(),n(20,"button",32),g("click",function(){let t=u(e).$implicit,a=l(2);return p(a.deleteDescuento(t.id))}),r(21," \u{1F5D1}\uFE0F "),n(22,"span",31),r(23,"Eliminar"),o()()()()}if(c&2){let e=m.$implicit,i=l(2);s(2),h(i.getNombreProducto(e.producto)),s(2),h(i.getNombreCampana(e.campana)),s(2),h(i.getNombreCategoriaDesdeProducto(e.producto)),s(2),h(i.getNombreSubcategoriaDesdeProducto(e.producto)),s(2),D("",I(11,8,e.porcentaje,"1.2-2"),"%"),s(3),k("px-2 py-1 rounded-full text-xs font-bold "+(e.activo?"bg-green-100 text-green-800":"bg-red-100 text-red-800")),s(),D(" ",e.activo?"S\xED":"No"," ")}}function oe(c,m){if(c&1&&(n(0,"option",12),r(1),o()),c&2){let e=m.$implicit;d("ngValue",e),s(),h(e.nombre)}}function re(c,m){if(c&1){let e=C();n(0,"li",50),g("click",function(){let t=u(e).$implicit,a=l(4);return p(a.selectProducto(t.id))}),r(1),o()}if(c&2){let e=m.$implicit;s(),D(" ",e.nombre," ")}}function ae(c,m){if(c&1&&(n(0,"ul",48),_(1,re,2,1,"li",49),o()),c&2){let e=l(3);s(),d("ngForOf",e.getProductosFiltradosPorNombre())}}function se(c,m){c&1&&(n(0,"div",51),E(1,"div",52),o())}function ce(c,m){if(c&1){let e=C();n(0,"div",33)(1,"div",34)(2,"h2",35),r(3),o(),n(4,"div",36)(5,"label",37),r(6,"\u{1F4E2} Campa\xF1a"),o(),n(7,"select",38),f("ngModelChange",function(t){u(e);let a=l(2);return b(a.selectedDescuento.campana,t)||(a.selectedDescuento.campana=t),p(t)}),n(8,"option",39),r(9,"Seleccione una campa\xF1a"),o(),_(10,oe,2,2,"option",13),o(),n(11,"label",37),r(12,"\u{1F4E6} Producto"),o(),n(13,"input",40),f("ngModelChange",function(t){u(e);let a=l(2);return b(a.productoBuscado,t)||(a.productoBuscado=t),p(t)}),g("input",function(){u(e);let t=l(2);return p(t.mostrarListaProductos=!0)}),o(),_(14,ae,2,1,"ul",41),n(15,"label",37),r(16,"\u{1F4C9} Porcentaje de Descuento"),o(),n(17,"input",42),f("ngModelChange",function(t){u(e);let a=l(2);return b(a.selectedDescuento.porcentaje,t)||(a.selectedDescuento.porcentaje=t),p(t)}),o(),n(18,"label",37),r(19,"\u{1F7E2} Activo"),o(),n(20,"select",43),f("ngModelChange",function(t){u(e);let a=l(2);return b(a.selectedDescuento.activo,t)||(a.selectedDescuento.activo=t),p(t)}),n(21,"option",12),r(22,"S\xED"),o(),n(23,"option",12),r(24,"No"),o()()(),n(25,"div",44)(26,"button",45),g("click",function(){u(e);let t=l(2);return p(t.saveDescuento())}),r(27," \u2705 Guardar "),o(),n(28,"button",46),g("click",function(){u(e);let t=l(2);return p(t.closeModal())}),r(29," \u274C Cancelar "),o()(),_(30,se,2,0,"div",47),o()()}if(c&2){let e=l(2);s(3),D(" ",e.isEditMode?"\u270F\uFE0F Editar Descuento":"\u2795 Registrar Descuento"," "),s(4),x("ngModel",e.selectedDescuento.campana),s(),d("ngValue",null),s(2),d("ngForOf",e.campanas),s(3),x("ngModel",e.productoBuscado),s(),d("ngIf",e.productoBuscado&&e.getProductosFiltradosPorNombre().length>0&&e.mostrarListaProductos),s(3),x("ngModel",e.selectedDescuento.porcentaje),s(3),x("ngModel",e.selectedDescuento.activo),s(),d("ngValue",!0),s(2),d("ngValue",!1),s(7),d("ngIf",e.isSaving)}}function le(c,m){if(c&1){let e=C();n(0,"div",4)(1,"h1",5),r(2,"Gestionar Descuentos"),o(),n(3,"div",6)(4,"div",7)(5,"button",8),g("click",function(){u(e);let t=l();return p(t.showAddModal())}),M(),n(6,"svg",9),E(7,"path",10),o(),r(8," Registrar Descuento "),o(),P(),n(9,"select",11),f("ngModelChange",function(t){u(e);let a=l();return b(a.campanaSeleccionada,t)||(a.campanaSeleccionada=t),p(t)}),g("change",function(){u(e);let t=l();return p(t.filterDescuentos())}),n(10,"option",12),r(11,"Todas las campa\xF1as"),o(),_(12,te,2,2,"option",13),o()(),n(13,"div",14)(14,"input",15),f("ngModelChange",function(t){u(e);let a=l();return b(a.searchTerm,t)||(a.searchTerm=t),p(t)}),g("ngModelChange",function(){u(e);let t=l();return p(t.filterDescuentos())}),o()()(),n(15,"div",16)(16,"table",17)(17,"thead",18)(18,"tr")(19,"th",19),r(20,"Producto"),o(),n(21,"th",19),r(22,"Campa\xF1a"),o(),n(23,"th",19),r(24,"Categor\xEDa"),o(),n(25,"th",19),r(26,"Subcategor\xEDa"),o(),n(27,"th",19),r(28,"Porcentaje"),o(),n(29,"th",19),r(30,"Activo"),o(),n(31,"th",20),r(32,"Acciones"),o()()(),n(33,"tbody"),_(34,ie,3,0,"tr",21)(35,ne,24,11,"tr",22),o()()(),n(36,"div",23)(37,"button",24),g("click",function(){u(e);let t=l();return p(t.prevPage())}),r(38,"Anterior"),o(),n(39,"span",25),r(40),o(),n(41,"button",24),g("click",function(){u(e);let t=l();return p(t.nextPage())}),r(42,"Siguiente"),o()(),_(43,ce,31,11,"div",26),o()}if(c&2){let e=l();s(9),x("ngModel",e.campanaSeleccionada),s(),d("ngValue",null),s(2),d("ngForOf",e.campanas),s(2),x("ngModel",e.searchTerm),s(20),d("ngIf",e.paginatedDescuentos().length===0),s(),d("ngForOf",e.paginatedDescuentos()),s(2),d("disabled",e.currentPage===1),s(3),T("P\xE1gina ",e.currentPage," de ",e.totalPages(),""),s(),d("disabled",e.currentPage===e.totalPages()),s(2),d("ngIf",e.showModal)}}var he=(()=>{class c{constructor(e){this.http=e,this.descuentos=[],this.productos=[],this.subcategorias=[],this.categorias=[],this.campanas=[],this.selectedDescuento=this.getEmptyDescuento(),this.showModal=!1,this.isEditMode=!1,this.isLoading=!1,this.isSaving=!1,this.productoBuscado="",this.mostrarListaProductos=!0,this.categoriaSeleccionada=null,this.subcategoriaSeleccionada=null,this.campanaSeleccionada=null,this.searchTerm="",this.currentPage=1,this.itemsPerPage=5,this.filteredDescuentos=[]}ngOnInit(){this.loadDescuentos(),this.loadProductos(),this.loadCategorias(),this.loadSubcategorias(),this.loadCampanas()}getEmptyDescuento(){return{id:0,producto:null,porcentaje:0,activo:!0,campana:null}}loadDescuentos(){this.isLoading=!0,this.http.get("http://137.184.94.190/api/descuentos/").subscribe({next:e=>{this.descuentos=e,this.filterDescuentos(),this.isLoading=!1},error:e=>{this.isLoading=!1,this.handleHttpError(e)}})}loadProductos(){this.http.get("http://137.184.94.190/api/productos/?page=1").subscribe({next:e=>{this.productos=e.results,this.filterDescuentos()},error:e=>this.handleHttpError(e)})}loadCategorias(){this.http.get("http://137.184.94.190/api/categorias/").subscribe(e=>this.categorias=e)}loadSubcategorias(){this.http.get("http://137.184.94.190/api/subcategorias/").subscribe(e=>this.subcategorias=e)}loadCampanas(){this.http.get("http://137.184.94.190/api/campanas/").subscribe(e=>this.campanas=e)}getNombreProducto(e){return e?.nombre||"Producto no encontrado"}getNombreSubcategoriaDesdeProducto(e){let i=typeof e.subcategoria=="object"?e.subcategoria.id:e.subcategoria,t=this.subcategorias.find(a=>a.id===i);return t?t.nombre:"\u2014"}getNombreCategoriaDesdeProducto(e){let i=typeof e.subcategoria=="object"?e.subcategoria.id:e.subcategoria,t=this.subcategorias.find(w=>w.id===i),a=typeof t?.categoria=="object"?t.categoria.id:t?.categoria,y=this.categorias.find(w=>w.id===a);return y?y.nombre:"\u2014"}getNombreCampana(e){return e?.nombre||"\u2014"}selectProducto(e){let i=this.productos.find(t=>t.id===e);this.selectedDescuento.producto=i||null,this.productoBuscado=i?.nombre||"",this.mostrarListaProductos=!1}getProductosFiltradosPorNombre(){let e=this.productoBuscado.toLowerCase();return this.productos.filter(i=>i.nombre.toLowerCase().includes(e))}showAddModal(){this.selectedDescuento=this.getEmptyDescuento(),this.productoBuscado="",this.mostrarListaProductos=!0,this.isEditMode=!1,this.showModal=!0}showEditModal(e){let i=this.campanas.find(t=>t.id===e.campana.id);this.selectedDescuento={id:e.id,producto:e.producto,porcentaje:e.porcentaje,activo:e.activo,campana:i||null},this.productoBuscado=e.producto?.nombre||"",this.mostrarListaProductos=!1,this.isEditMode=!0,this.showModal=!0}saveDescuento(){if(!this.selectedDescuento.campana||!this.selectedDescuento.producto){v.default.fire("Campos requeridos","Debes seleccionar una campa\xF1a y un producto.","warning");return}let e={campana_id:this.selectedDescuento.campana.id,producto_id:this.selectedDescuento.producto.id,porcentaje:this.selectedDescuento.porcentaje,activo:this.selectedDescuento.activo};console.log("Payload enviado:",e),this.isSaving=!0,(this.isEditMode?this.http.put(`http://137.184.94.190/api/descuentos/${this.selectedDescuento.id}/`,e):this.http.post("http://137.184.94.190/api/descuentos/",e)).subscribe({next:()=>{v.default.fire("Guardado",`Descuento ${this.isEditMode?"actualizado":"registrado"} correctamente.`,"success"),this.loadDescuentos(),this.closeModal(),this.isSaving=!1},error:t=>{this.isSaving=!1;let a=this.formatErrors(t?.error);v.default.fire("Error al guardar",a,"error")}})}deleteDescuento(e){v.default.fire({title:"\xBFEliminar descuento?",text:"Esta acci\xF3n no se puede deshacer.",icon:"warning",showCancelButton:!0,confirmButtonText:"S\xED, eliminar"}).then(i=>{i.isConfirmed&&this.http.delete(`http://137.184.94.190/api/descuentos/${e}/`).subscribe({next:()=>{v.default.fire("Eliminado","El descuento fue eliminado.","success"),this.loadDescuentos()},error:t=>this.handleHttpError(t)})})}closeModal(){this.showModal=!1,this.selectedDescuento=this.getEmptyDescuento(),this.productoBuscado="",this.mostrarListaProductos=!0}filterDescuentos(){this.filteredDescuentos=this.descuentos.filter(e=>{let i=e.producto,t=typeof i.subcategoria=="object"?i.subcategoria.id:i.subcategoria,a=this.subcategorias.find(X=>X.id===t),y=typeof a?.categoria=="object"?a.categoria.id:a?.categoria,w=!this.categoriaSeleccionada||y===this.categoriaSeleccionada,K=!this.subcategoriaSeleccionada||a?.id===this.subcategoriaSeleccionada,Q=!this.campanaSeleccionada||e.campana.id===(typeof this.campanaSeleccionada=="object"?this.campanaSeleccionada.id:this.campanaSeleccionada),U=this.searchTerm.trim()===""||i?.nombre.toLowerCase().includes(this.searchTerm.toLowerCase());return w&&K&&Q&&U}),this.currentPage=1}paginatedDescuentos(){let e=(this.currentPage-1)*this.itemsPerPage;return this.filteredDescuentos.slice(e,e+this.itemsPerPage)}totalPages(){return Math.ceil(this.filteredDescuentos.length/this.itemsPerPage)}nextPage(){this.currentPage<this.totalPages()&&this.currentPage++}prevPage(){this.currentPage>1&&this.currentPage--}handleHttpError(e){console.error("HTTP Error:",e);let i=this.formatErrors(e?.error);v.default.fire("Error",i,"error")}formatErrors(e){return!e||typeof e!="object"?"Error desconocido":Object.entries(e).map(([i,t])=>Array.isArray(t)?`<strong>${i}:</strong> ${t.join(", ")}`:t&&typeof t=="object"?`<strong>${i}:</strong><br>`+Object.entries(t).map(([a,y])=>`&nbsp;&nbsp;\u2192 ${a}: ${y}`).join("<br>"):`<strong>${i}:</strong> ${JSON.stringify(t)}`).join("<br>")}static{this.\u0275fac=function(i){return new(i||c)(V(W))}}static{this.\u0275cmp=S({type:c,selectors:[["app-descuentos"]],standalone:!0,features:[j],decls:2,vars:2,consts:[["class","spinner-container",4,"ngIf"],["class","container mx-auto px-4 py-8",4,"ngIf"],[1,"spinner-container"],[1,"spinner"],[1,"container","mx-auto","px-4","py-8"],[1,"text-3xl","font-bold","text-gray-800","mb-4"],[1,"flex","flex-col","sm:flex-row","sm:items-center","sm:justify-between","gap-4","mb-6"],[1,"flex","flex-wrap","items-center","gap-3"],[1,"flex","items-center","gap-2","bg-purple-600","hover:bg-purple-700","text-white","px-4","py-2","rounded-lg","shadow-md","transition",3,"click"],["xmlns","http://www.w3.org/2000/svg","fill","white","viewBox","0 0 24 24","stroke","currentColor",1,"h-5","w-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],[1,"px-3","py-2","border","rounded-lg","bg-gray-100","text-black","w-auto","max-w-fit",3,"ngModelChange","change","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"w-full","sm:w-auto"],["type","text","placeholder","Buscar producto...",1,"w-full","sm:w-72","px-4","py-2","border","border-gray-300","rounded-lg","focus:outline-none","focus:border-purple-500",3,"ngModelChange","ngModel"],[1,"overflow-x-auto"],[1,"min-w-full","bg-white","rounded-lg","shadow","text-sm"],[1,"bg-gray-800","text-white"],[1,"p-3"],[1,"p-3","text-center"],[4,"ngIf"],["class","hover:bg-gray-50 border-b",4,"ngFor","ngForOf"],[1,"mt-6","flex","justify-end","items-center","gap-2"],[1,"px-3","py-1","rounded","bg-gray-200","hover:bg-gray-300","disabled:opacity-50",3,"click","disabled"],[1,"text-sm","font-medium","text-gray-700"],["class","fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center",4,"ngIf"],["colspan","7",1,"text-center","text-gray-500","py-4"],[1,"hover:bg-gray-50","border-b"],[1,"p-3","text-center","flex","gap-2","justify-center"],["title","Editar",1,"text-blue-600","hover:text-blue-800",3,"click"],[1,"sr-only","sm:not-sr-only"],["title","Eliminar",1,"text-red-600","hover:text-red-800",3,"click"],[1,"fixed","inset-0","z-50","bg-black","bg-opacity-50","flex","items-center","justify-center"],[1,"bg-white","w-full","max-w-lg","p-6","rounded-xl","shadow-xl","relative","overflow-y-auto","max-h-[90vh]"],[1,"text-2xl","font-bold","mb-6","text-center","text-purple-600"],[1,"space-y-4"],[1,"block","font-bold","mb-1"],[1,"w-full","px-3","py-2","border","rounded-lg","bg-gray-100","text-black",3,"ngModelChange","ngModel"],["disabled","",3,"ngValue"],["type","text","placeholder","Buscar producto...",1,"w-full","px-3","py-2","border","rounded-lg","bg-gray-100","text-black",3,"ngModelChange","input","ngModel"],["class","bg-white border border-gray-300 rounded-md shadow max-h-40 overflow-y-auto mt-1 text-black z-10 relative",4,"ngIf"],["type","number",1,"w-full","px-3","py-2","border","rounded-lg","bg-gray-100",3,"ngModelChange","ngModel"],[1,"w-full","px-3","py-2","border","rounded-lg","bg-gray-100",3,"ngModelChange","ngModel"],[1,"mt-6","flex","justify-between"],[1,"bg-purple-600","hover:bg-purple-700","text-white","px-6","py-2","rounded-lg","shadow",3,"click"],[1,"bg-gray-500","hover:bg-gray-600","text-white","px-6","py-2","rounded-lg","shadow",3,"click"],["class","absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-xl",4,"ngIf"],[1,"bg-white","border","border-gray-300","rounded-md","shadow","max-h-40","overflow-y-auto","mt-1","text-black","z-10","relative"],["class","px-3 py-2 hover:bg-purple-100 cursor-pointer",3,"click",4,"ngFor","ngForOf"],[1,"px-3","py-2","hover:bg-purple-100","cursor-pointer",3,"click"],[1,"absolute","inset-0","bg-black","bg-opacity-50","flex","items-center","justify-center","rounded-xl"],[1,"w-12","h-12","border-4","border-white","border-t-purple-500","rounded-full","animate-spin"]],template:function(i,t){i&1&&_(0,ee,2,0,"div",0)(1,le,44,11,"div",1),i&2&&(d("ngIf",t.isLoading),s(),d("ngIf",!t.isLoading))},dependencies:[N,F,L,B,J,q,R,A,$,G,H,z],styles:[".spinner-container[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:#000c;display:flex;justify-content:center;align-items:center;z-index:1000}.spinner[_ngcontent-%COMP%]{border:4px solid rgba(255,255,255,.3);border-top:4px solid #ffffff;border-radius:50%;width:50px;height:50px;animation:_ngcontent-%COMP%_spin 1s linear infinite}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;margin-bottom:20px}thead[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{background-color:#343a40;color:#fff}th[_ngcontent-%COMP%], td[_ngcontent-%COMP%]{border:1px solid #dee2e6;padding:12px;text-align:left}tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:nth-child(2n){background-color:#f8f9fa}input[type=text][_ngcontent-%COMP%], input[type=file][_ngcontent-%COMP%], textarea[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc}button[_ngcontent-%COMP%]{padding:10px 20px;border-radius:8px;font-weight:700;cursor:pointer;transition:background-color .3s ease}button[_ngcontent-%COMP%]:hover{opacity:.9}@media (max-width: 768px){table[_ngcontent-%COMP%]{font-size:14px}button[_ngcontent-%COMP%]{width:100%;margin-top:10px}}"]})}}return c})();export{he as DescuentosComponent};
